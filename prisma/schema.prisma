// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


model User {
    id String @id @default(cuid())
    email String? @unique
    password String? // it will be null if the user signed up using OAuth
    provider String? // eg'google', 'github'
    providerId String?
    firstName String?
    lastName String?
    username String @unique
    bio String?
    profileImage String?
    isVerified Boolean @default(false)
    verificationToken String?
    verificationTokenExpires DateTime?
    resetPasswordToken String?
    resetPasswordTokenExpires DateTime?
    needsUsernameUpdate Boolean @default(false) // for the first time, giving a temp username in oauth

    // Relations
    ownedAPIs              Api[]           @relation("OwnedAPIs")
    bookmarkedAPIs         Bookmark[]      // many-to-many via Bookmark
    ratings                Rating[]        // ratings given by user
    subscriptions          Subscription[]  // future
    apiKey                 ApiKey[] // each user will have a api key after subscription
    endpointLogs           EndpointLog[] // to store endoipnt logs

    lastLogin DateTime?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([providerId, provider])
}


model Api {
    id                String      @id @default(cuid())
    name              String?
    description       String?
    logo              String?     @default("https://raw.githubusercontent.com/DurgeshChouksey/ApiVersePublicUtilities/main/public/temp-api-logo.png")
    baseUrl           String
    category          String
    visibility        String      @default("public")
    requiresApiKey    Boolean     @default(false)
    totalViews        Int         @default(0)
    averageRating     Float?
    providerAuthType   String?   // "apiKey", "oauth2", etc.
    providerAuthLocation String? // "query" "header"
    providerAuthField String?    // "apiId"(query), "X-API-KEY"(header)
    providerAuthKey    String?   // encrypted key/token (never exposed to frontend)

    // Relations
    owner             User        @relation("OwnedAPIs", fields: [ownerId], references: [id])
    ownerId           String
    endpoints         Endpoint[]
    bookmarks         Bookmark[]
    ratings           Rating[]
    subscriptions     Subscription[] // future
    apiKey            ApiKey[]
    apiLogs           ApiLog[]
    apiDocs           ApiDocs[]

    createdAt         DateTime    @default(now())
    updatedAt         DateTime    @updatedAt
}

model Endpoint {
    id            String   @id @default(cuid())
    name          String?
    path          String
    method        String
    description   String?
    authRequired  Boolean  @default(false)

    // Parameters
    queryParameters  Json?    // array of { name, type, required, enumValues?, example }
    bodyParameters   Json?    // array of bodyContentType === form-data ? { name, type, required, enumValues?, example } : {payload, payloadDesc, body, schema}
    bodyContentType  String?  // e.g., application/json, application/x-www-form-urlencoded, form-data, plain-text
    headers          Json?    // array of { name, value?, required }

    // relations
    api           Api      @relation(fields: [apiId], references: [id])
    apiId         String
    endpointLogs           EndpointLog[] // to store endoipnt logs

    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

model Bookmark {
    id        String @id @default(cuid())
    user      User   @relation(fields: [userId], references: [id])
    userId    String
    api       Api    @relation(fields: [apiId], references: [id])
    apiId     String
    createdAt DateTime @default(now())

    @@unique([userId, apiId])
}

model Rating {
    id        String  @id @default(cuid())
    value     Int     // 1-5
    comment   String?
    user      User    @relation(fields: [userId], references: [id])
    userId    String
    api       Api     @relation(fields: [apiId], references: [id])
    apiId     String

    createdAt DateTime @default(now())
}

model Subscription {
    id        String @id @default(cuid())
    user      User   @relation(fields: [userId], references: [id])
    userId    String
    api       Api    @relation(fields: [apiId], references: [id])
    apiId     String
    plan      String
    active    Boolean @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, apiId])
}


model ApiKey {
    id        String   @id @default(cuid())
    key       String   @unique      // the actual API key
    api       Api      @relation(fields: [apiId], references: [id])
    apiId     String
    user      User?    @relation(fields: [userId], references: [id]) // optional: if keys are user-specific
    userId    String?
    active    Boolean  @default(true)
    createdAt DateTime @default(now())
    lastUsed  DateTime?

    @@unique([apiId, userId])
}


// LOGS

model EndpointLog {
    id          String   @id @default(cuid())
    endpoint    Endpoint @relation(fields: [endpointId], references: [id])
    endpointId  String
    user        User?    @relation(fields: [userId], references: [id])
    userId      String?  // optional if anonymous
    success     Boolean
    latency     Int      // in milliseconds
    errorMessage String?
    createdAt   DateTime @default(now())
}

model ApiLog {
    id           String  @id @default(cuid())
    api          Api     @relation(fields: [apiId], references: [id])
    apiId        String
    totalCalls   Int     @default(0)
    totalErrors  Int     @default(0)
    averageLatency Float?
    createdAt    DateTime @default(now())
}


model ApiDocs {
    id String @id @default(cuid())
    api Api @relation(fields: [apiId], references: [id])
    apiId String
    content String?   // store markdown text
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}
