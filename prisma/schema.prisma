// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


model User {
    id String @id @default(cuid())
    email String? @unique
    password String? // it will be null if the user signed up using OAuth
    provider String? // eg'google', 'github'
    providerId String?
    firstName String?
    lastName String?
    username String @unique
    bio String?
    profileImage String?
    isVerified Boolean @default(false)
    verificationToken String?
    verificationTokenExpires DateTime?
    resetPasswordToken String?
    resetPasswordTokenExpires DateTime?
    needsUsernameUpdate Boolean @default(false) // for the first time, giving a temp username in oauth

    // Relations
    ownedAPIs              Api[]           @relation("OwnedAPIs")
    bookmarkedAPIs         Bookmark[]      // many-to-many via Bookmark
    ratings                Rating[]        // ratings given by user
    subscriptions          Subscription[]  // future
    apiKey                 ApiKey[] // each user will have a api key after subscription

    lastLogin DateTime?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([providerId, provider])
}


model Api {
    id                String      @id @default(cuid())
    name              String
    description       String?
    logo              String?     @default("https://raw.githubusercontent.com/DurgeshChouksey/ApiVersePublicUtilities/main/public/temp-api-logo.png")
    baseUrl           String
    category          String
    visibility        String      @default("public")
    errorCount        Int         @default(0)
    totalViews        Int         @default(0)
    totalCalls        Int         @default(0)
    averageRating     Float?

    // Relations
    owner             User        @relation("OwnedAPIs", fields: [ownerId], references: [id])
    ownerId           String
    endpoints         Endpoint[]
    bookmarks         Bookmark[]
    ratings           Rating[]
    subscriptions     Subscription[] // future
    apiKey            ApiKey[]

    createdAt         DateTime    @default(now())
    updatedAt         DateTime    @updatedAt
}

model Endpoint {
    id            String   @id @default(cuid())
    path          String
    method        String
    description   String?
    parameters    Json?
    headers       Json?
    authRequired  Boolean  @default(false)
    api           Api      @relation(fields: [apiId], references: [id])
    apiId         String

    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

model Bookmark {
    id        String @id @default(cuid())
    user      User   @relation(fields: [userId], references: [id])
    userId    String
    api       Api    @relation(fields: [apiId], references: [id])
    apiId     String
    createdAt DateTime @default(now())

    @@unique([userId, apiId])
}

model Rating {
    id        String  @id @default(cuid())
    value     Int     // 1-5
    comment   String?
    user      User    @relation(fields: [userId], references: [id])
    userId    String
    api       Api     @relation(fields: [apiId], references: [id])
    apiId     String

    createdAt DateTime @default(now())
}

model Subscription {
    id        String @id @default(cuid())
    user      User   @relation(fields: [userId], references: [id])
    userId    String
    api       Api    @relation(fields: [apiId], references: [id])
    apiId     String
    plan      String
    active    Boolean @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, apiId])
}


model ApiKey {
    id        String   @id @default(cuid())
    key       String   @unique      // the actual API key
    api       Api      @relation(fields: [apiId], references: [id])
    apiId     String
    user      User?    @relation(fields: [userId], references: [id]) // optional: if keys are user-specific
    userId    String?
    active    Boolean  @default(true)
    createdAt DateTime @default(now())
    lastUsed  DateTime?

    @@unique([apiId, key])
}
